const w="https://openrouter.ai/api/v1/chat/completions";async function l(a,o={},n=!1){var i,c,m;const s=((i=o.apiKey)==null?void 0:i.trim())||((c=o.secondaryApiKey)==null?void 0:c.trim());if(!s)throw new Error("No OpenRouter API key found. Add your key in the Settings view to continue.");const u=o.mainModel||"openrouter/polaris-alpha",h=o.backupModel||"x-ai/grok-4-fast",p=n?h:u;let t=[...a];o.systemInstruction&&o.systemInstruction.trim()&&(t.some(r=>r.role==="system")||(t=[{role:"system",content:o.systemInstruction},...t]));const d=o.temperature??.7,y=o.maxTokens??128e3;try{const e=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`,"HTTP-Referer":window.location.origin,"X-Title":"Chat Platform Template"},body:JSON.stringify({model:p,messages:t,temperature:d,max_tokens:y})});if(!e.ok){const f=await e.json().catch(()=>({error:{message:`HTTP ${e.status}: ${e.statusText}`}}));if(!n&&e.status>=500)return console.warn("Main model failed, trying backup model..."),l(a,o,!0);throw new Error(((m=f.error)==null?void 0:m.message)||`API request failed: ${e.statusText}`)}const r=await e.json();if(!r.choices||r.choices.length===0)throw new Error("No response from API");return r.choices[0].message.content}catch(e){if(!n&&e instanceof TypeError&&e.message.includes("fetch"))return console.warn("Network error with main model, trying backup model..."),l(a,o,!0);throw e}}export{l as sendMessage};
